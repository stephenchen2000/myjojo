# ♿ 全新项目设置可访问性测试 (a11y)

> 📌 **前提条件**：已完成 [Render.md](./Render.md) 中的步骤 1-4

## 在渲染测试基础上，a11y 测试额外需要：

| 区别 | 渲染测试 | a11y 测试 |
|------|----------|----------|
| 额外依赖 | ❌ 不需要 | ✅ @storybook/addon-a11y |
| 配置文件 | 基础配置 | 需要配置 addon + preview + setup |
| play 函数 | 可选 | ❌ 通常跳过（纯静态检查） |
| 测试内容 | 组件渲染 | WCAG 无障碍标准 |

---

## 步骤 5: 安装 a11y 依赖

```bash
npm install -D @storybook/addon-a11y
```

---

## 步骤 6: 配置 Storybook

### 6.1 添加 addon（.storybook/main.ts）

```ts
import type { StorybookConfig } from '@storybook/react-vite';

const config: StorybookConfig = {
  stories: ['../src/**/*.stories.@(js|jsx|mjs|ts|tsx)'],
  addons: [
    '@storybook/addon-vitest',
    '@storybook/addon-a11y',  // 🔑 添加 a11y addon
    '@storybook/addon-docs',
  ],
  framework: '@storybook/react-vite',
};

export default config;
```

### 6.2 配置 a11y 行为（.storybook/preview.ts）

```ts
import type { Preview } from '@storybook/react-vite';

const preview: Preview = {
  parameters: {
    controls: {
      matchers: {
        color: /(background|color)$/i,
        date: /Date$/i,
      },
    },

    // 🔑 a11y 配置
    a11y: {
      // 'error' - 命令行测试时 a11y 违规会导致测试失败
      // 'todo' - 只在 Storybook UI 显示警告，不影响测试
      // 'off' - 完全跳过 a11y 检查
      test: import.meta.env.VITE_SKIP_A11Y ? 'off' : 'error',
    },
  },

  // 🔑 a11y 测试时跳过 play 函数（纯静态检查）
  loaders: import.meta.env.VITE_SKIP_PLAY
    ? [async () => ({})]
    : undefined,
};

export default preview;
```

### 6.3 配置 Vitest setup（.storybook/vitest.setup.ts）

```ts
import * as a11yAddonAnnotations from '@storybook/addon-a11y/preview';  // 🔑 导入 a11y 注解
import { setProjectAnnotations } from '@storybook/react-vite';
import * as projectAnnotations from './preview';

// 应用 a11y 注解到测试
setProjectAnnotations([a11yAddonAnnotations, projectAnnotations]);
```

---

## 步骤 7: 添加测试脚本（package.json）

```json
{
  "scripts": {
    "test:a11y": "cross-env VITE_SKIP_PLAY=true vitest --project=storybook --run"
  }
}
```

> 💡 `VITE_SKIP_PLAY=true` 跳过 play 函数，只做静态 a11y 检查

---

## 步骤 8: 运行测试

```bash
npm run test:a11y
```

---

## 🔍 a11y 检测的内容

基于 [axe-core](https://github.com/dequelabs/axe-core)，检测 WCAG 标准：

| 类别 | 检测项 |
|------|--------|
| **颜色对比** | 文本与背景的对比度是否足够 |
| **替代文本** | 图片是否有 alt 属性 |
| **表单标签** | 输入框是否有关联的 label |
| **键盘导航** | 交互元素是否可通过键盘访问 |
| **ARIA** | ARIA 属性是否正确使用 |
| **语义化** | 是否使用正确的 HTML 元素 |

---

## 🛠️ 常见 a11y 问题修复

### 1. 按钮缺少可访问名称

```jsx
// ❌ 错误
<button><Icon /></button>

// ✅ 正确
<button aria-label="关闭"><Icon /></button>
```

### 2. 图片缺少 alt 属性

```jsx
// ❌ 错误
<img src="avatar.png" />

// ✅ 正确
<img src="avatar.png" alt="用户头像" />

// ✅ 装饰性图片
<img src="decoration.png" alt="" role="presentation" />
```

### 3. 表单缺少 label

```jsx
// ❌ 错误
<input type="text" placeholder="Email" />

// ✅ 正确
<label htmlFor="email">邮箱</label>
<input id="email" type="text" />

// ✅ 或使用 aria-label
<input type="text" aria-label="邮箱" />
```

### 4. 颜色对比度不足

```css
/* ❌ 错误 - 浅灰色文字在白色背景 */
.text { color: #ccc; background: #fff; }

/* ✅ 正确 - 对比度 ≥ 4.5:1 */
.text { color: #666; background: #fff; }
```

---

## ⚙️ 针对特定 Story 配置 a11y

### 禁用特定规则

```jsx
export const SpecialCase = {
  args: { /* ... */ },
  parameters: {
    a11y: {
      config: {
        rules: [
          { id: 'color-contrast', enabled: false },  // 禁用颜色对比检查
        ],
      },
    },
  },
};
```

### 完全跳过 a11y 检查

```jsx
export const SkipA11y = {
  args: { /* ... */ },
  parameters: {
    a11y: {
      test: 'off',  // 跳过此 Story 的 a11y 测试
    },
  },
};
```

---

## 📋 快速检查清单

| 步骤 | 内容 | 说明 |
|------|------|------|
| 1-4 | 基础设置 | 参考 Render.md |
| 5 | 安装依赖 | `@storybook/addon-a11y` |
| 6.1 | 配置 main.ts | 添加 addon |
| 6.2 | 配置 preview.ts | 设置 a11y 参数 |
| 6.3 | 配置 vitest.setup.ts | 导入 a11y 注解 |
| 7 | 配置脚本 | 添加 `test:a11y` |
| 8 | 运行测试 | `npm run test:a11y` |

---

## 🎯 三种测试的对比

| 测试类型 | 命令 | play 函数 | a11y 检查 | 用途 |
|----------|------|-----------|-----------|------|
| **渲染测试** | `test:render` | ❌ 跳过 | ❌ 跳过 | 组件能否渲染 |
| **交互测试** | `test:interaction` | ✅ 执行 | ❌ 跳过 | 用户操作是否正常 |
| **a11y 测试** | `test:a11y` | ❌ 跳过 | ✅ 执行 | 无障碍合规检查 |
| **全部测试** | `test:all` | ✅ 执行 | ✅ 执行 | 完整测试 |

> 💡 **提示**：在 Storybook UI 中，a11y 检测结果会显示在 Accessibility 面板中，方便可视化调试。

