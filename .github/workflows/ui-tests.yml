name: 'UI Tests'

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # å®‰è£…å’Œç¼“å­˜ä¾èµ–
  install-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
            
      - name: å®‰è£…ä¾èµ–
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci --legacy-peer-deps
        
      - name: å®‰è£… Playwright
        if: steps.cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

  # 1ï¸âƒ£ äº¤äº’æµ‹è¯•ï¼ˆplay å‡½æ•°ï¼‰
  test-interaction:
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          
      - name: ğŸ–±ï¸ è¿è¡Œäº¤äº’æµ‹è¯•
        run: npm run test:interaction

  # 2ï¸âƒ£ æ¸²æŸ“æµ‹è¯•ï¼ˆåŸºç¡€æ˜¾ç¤ºï¼‰
  test-render:
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          
      - name: ğŸ“„ è¿è¡Œæ¸²æŸ“æµ‹è¯•
        run: npm run test:render

  # 3ï¸âƒ£ å¯è®¿é—®æ€§æµ‹è¯•ï¼ˆa11yï¼‰
  test-a11y:
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          
      - name: â™¿ è¿è¡Œå¯è®¿é—®æ€§æµ‹è¯•
        run: npm run test:a11y

  # 4ï¸âƒ£ Chromatic å¯è§†åŒ–å›å½’æµ‹è¯•
  test-chromatic:
    runs-on: ubuntu-latest
    needs: install-cache
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          
      - name: ğŸ¨ è¿è¡Œ Chromatic æµ‹è¯•
        run: npm run chromatic -- --exit-zero-on-changes
        env:
          CHROMATIC_PROJECT_TOKEN: chpt_fa03fefd88a5bcd

  # 5ï¸âƒ£ E2E ç«¯åˆ°ç«¯æµ‹è¯•
  test-e2e:
    runs-on: ubuntu-latest
    needs: install-cache
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - uses: actions/checkout@v4
        
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          
      - name: ğŸ­ è¿è¡Œ E2E æµ‹è¯• - ${{ matrix.browser }}
        run: npm run test:e2e -- --project=${{ matrix.browser }}
        
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 30
